<?phpnamespace AppBundle\Service;use AppBundle\Entity\Number;use AppBundle\Entity\Result;use AppBundle\Entity\ResultNumber;use Doctrine\ORM\EntityManager;use function PHPSTORM_META\type;use Symfony\Component\Console\Output\OutputInterface;use Symfony\Component\DomCrawler\Crawler;use Symfony\Component\DependencyInjection\ContainerInterface;class TirageService{    private $baseFolder = '../var';    /** @var ContainerInterface $container */    private $container = null;    /**     * TirageService constructor.     * @param ContainerInterface $container     */    public function __construct(ContainerInterface $container)    {        $this->container = $container;    }    /**     * @param OutputInterface $output     */    public function run(OutputInterface $output)    {        $output->writeln('Run');        //https://www.reducmiz.com/resultat_fdj.php?jeu=loto&nb=all        $url = "https://www.reducmiz.com/resultat_fdj.php?jeu=loto&nb=50";        $this->importData($url);        die('Run');    }    public function importData(String $url)    {        $dom = new \DOMDocument('1.0');        ini_set('memory_limit', "-1");        //        @$dom->loadHTMLFile($this->crawl($url));        $appPath = $this->container->getParameter('kernel.root_dir') . DIRECTORY_SEPARATOR . $this->baseFolder . DIRECTORY_SEPARATOR . 'data';        $file = $appPath . DIRECTORY_SEPARATOR . 'data.html';        @$dom->loadHTMLFile($file);        //echo $dom->saveHTML();//        $elements = $dom->getElementsByTagName('body');        $elements = $dom->getElementsByTagName('table');        if (!is_null($elements)) {            /** @var EntityManager $em */            $em = $this->container->get('doctrine')->getManager();            foreach ($elements as $element) {                $result = new Result();//                echo "<br/>" . $element->nodeName . ": ";//                dump($element->nodeName);//                $nodes = $element->childNodes;//                dump($nodes);//                die;                /** @var \DOMNodeList $line */                $line = $element->getElementsByTagName('tr');                foreach ($line as $k => $tr) {                    /** @var \DOMNodeList $colArray */                    $colArray = $tr->getElementsByTagName('td');                    if ($colArray->length > 0 && !is_null($colArray) && $colArray instanceof \DOMNodeList) {                        $value = $colArray->item(0);                        dump($value->nodeValue);                        if ($value instanceof \DOMElement && !is_null($value)) {                            switch (trim($value->nodeValue)) {                                case 'date du tirage':                                    if ($colArray->item(1) instanceof \DOMElement && !is_null($colArray->item(1))) {                                        $data = explode(" ", $colArray->item(1)->nodeValue);                                        $date = \DateTime::createFromFormat('d/m/Y', end($data))->format('Y-m-d');                                        $result->setDate(new \DateTime($date));                                    }                                    break;                                case 'tirage'://                                    $lottery = explode(" ", $this->clean($colArray->item(1)->nodeValue));//                                    if (is_array($lottery)) {//                                        foreach ($lottery as $key => $lot) {////                                            /** @var Number $number *///                                            $number = $em->getRepository(Number::class)->findOneByValue(intval($this->cleanSpace($lot)));////                                            if ($number instanceof Number) {//                                                $resNumb = new ResultNumber();//                                                $resNumb->setResult($result)->setPosition($key + 1)->setBonus(false);//                                                $resNumb->setNumber($number);//                                                $em->persist($resNumb);//                                                $result->addResultNumber($resNumb);//                                            }////                                        }////                                    }                                    break;                                case 'numéro chance'://                                    $lottery = $this->clean($colArray->item(1)->nodeValue);//                                    /** @var Number $number *///                                    $number = $em->getRepository(Number::class)->findOneByValue(intval($this->cleanSpace($lottery)));////                                    if ($number instanceof Number) {//                                        $resNumb = new ResultNumber();//                                        $resNumb->setResult($result)->setNumber($number)->setBonus(true);//                                        $em->persist($resNumb);//                                        $result->addResultNumber($resNumb);//                                    }                                    break;                                case '5 bons nums+ numéro chance':                                    break;                                case '5 bons nums':                                    break;                                case '4 b. n. + num chance':                                    break;                                case '4 bons nums':                                    break;                                case '3 b. n. + num chance':                                    break;                                case '3 bons nums':                                    break;                                case '2 b. n. + num chance':                                    break;                                case '2 bons nums':                                    break;                                case '1 ou 0 b. n. + num chance':                                    break;                                case 'JOKER+®':                                    break;                                case "Codes à 21,000€":                                    break;                            }                        }                    }                } // ENDFOR TR LINE                 dump($result);                die('Fin');            }        }    }    function clean($text)    {        return html_entity_decode(trim(str_replace(';', '-', preg_replace('/\s+/S', " ", strip_tags($text)))));//        echo '\n';// throw a new line    }    function cleanSpace(string $char): string    {        $string = str_replace(' ', '', trim(strval($char)));        return (strlen($string) > 2) ? substr($string, -2) : $string;    }    public function crawl(string $url): string    {        $ch = curl_init($url);        $appPath = $this->container->getParameter('kernel.root_dir');        $fileName = 'data.html';        $targetMove = $appPath . DIRECTORY_SEPARATOR . $this->baseFolder . DIRECTORY_SEPARATOR . 'data';        if (!is_dir($targetMove)) {            @mkdir($targetMove);        }        $file = $targetMove . DIRECTORY_SEPARATOR . $fileName;        if (file_exists($file)) {            unlink($file);        }        $fp_file = fopen($file, 'a');        curl_setopt($ch, CURLOPT_FILE, $fp_file);        curl_setopt($ch, CURLOPT_HEADER, 0);        curl_exec($ch);        curl_close($ch);        fclose($fp_file);        unset($ch, $fp_file, $targetMove, $appPath);        return $file;    }    function url_check($url)    {        $headers = @get_headers($url);        return is_array($headers) ? preg_match('/^HTTP\\/\\d+\\.\\d+\\s+2\\d\\d\\s+.*$/', $headers[0]) : false;    }}/* *   <table class="table table-condensed table-striped">            <tr>                <td>date du tirage</td>                <td align="left" colspan="2"><b>samedi 23/12/2017</b></td>            </tr>            <tr>                <td>tirage</td>                <td bgcolor="#8B0000" align="center" colspan="2"><b><font color="#FFFFFF">4 &nbsp;6 &nbsp;8 &nbsp;44                    &nbsp;48</font></b></td>            </tr>            <tr>                <td>num&eacute;ro chance</td>                <td bgcolor="#FFE4E1" align="center" colspan="2">10</td>            </tr>            <tr>                <td>5 bons nums<br>+ num&eacute;ro chance</td>                <td align="right">0 gagnant</td>                <td align="right">- &#8364;</td>            </tr>            <tr>                <td>5 bons nums</td>                <td align="right">4</td>                <td align="right">100 000 &#8364;</td>            </tr>            <tr>                <td>4 b. n. + num chance</td>                <td align="right">59</td>                <td align="right">1 000 &#8364;</td>            </tr>            <tr>                <td>4 bons nums</td>                <td align="right">561</td>                <td align="right">500 &#8364;</td>            </tr>            <tr>                <td>3 b. n. + num chance</td>                <td align="right">2413</td>                <td align="right">50 &#8364;</td>            </tr>            <tr>                <td>3 bons nums</td>                <td align="right">27384</td>                <td align="right">20 &#8364;</td>            </tr>            <tr>                <td>2 b. n. + num chance</td>                <td align="right">33659</td>                <td align="right">10 &#8364;</td>            </tr>            <tr>                <td>2 bons nums</td>                <td align="right">395738</td>                <td align="right">5 &#8364;</td>            </tr>            <tr>                <td>1 ou 0 b. n. + num chance</td>                <td align="right">424226</td>                <td align="right">2,2 &#8364;</td>            </tr>            <tr>                <td>JOKER+&reg;</td>                <td align="center" colspan="2">0 964 301</td>            </tr>            <tr>                <td>Codes &agrave; 20,000&#8364;</td>                <td align="center" colspan="2">I24908542 ; C18403711 ; F51273828 ; Q09430343 ; E92435504 ; G43146909 ;                    V36877529 ; L50964805 ; F03319230 ; N74946156                </td>            </tr>        </table> * */